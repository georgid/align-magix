<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="./js/nexusUI.js"></script>
        <link rel="stylesheet" href="./css/main.css"/>
        <title>Generate Text To Speech Annotation</title>
    </head>
    <body>
        <div class="width_50">
            Text to speech generator/annotator. (Enter Text in the left and press "Say it!")
        </div>
        <div >
            <textarea class="width_50" name="text" id ="text" rows="50"></textarea>
            <textarea  class="width_50" name="text_annotated" id ="text_annotated" rows="50"></textarea>
        </div> 
        <div class="width_50">
            <div>
                pitch <canvas nx="slider"width = 200 height=20></canvas> <span id = "pitch_value"></span>
            </div>
            <div>
                rate <canvas nx="slider" width = 200 height=20></canvas> <span id = "rate_value"></span>
            </div>
            <div>
                Say it!<canvas nx="button"></canvas>
            </div>
            
        </div>
    </body>
    <script>
        var pitch = 1;
        var rate = 1;
        var rate_scale = 3;
        var pitch_scale = 2;
        nx.onload = function() {
            
            slider1.hslider = true;
            slider1.value = pitch/pitch_scale;
            $("#pitch_value").text(pitch);

            slider1.draw();
            slider2.hslider = true;
            slider1.value = rate/rate_scale;
            $("#rate_value").text(rate);


            slider2.draw();

            slider1.on('*', function(data){
                pitch =  data.value * pitch_scale;
                $("#pitch_value").text(pitch);
            });

            slider2.on('*', function(data){
                rate =  data.value * rate_scale
                $("#rate_value").text(rate);
            });

            button1.mode = "impulse";
            button1.draw();
            var startingTimestamp = 0;
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Welcome to text to speech generator/annotator."));

            button1.on('*', function(data) {
                var voices = window.speechSynthesis.getVoices();
                //console.log(voices);
                txt = $("#text").val();
                if (txt==""){
                    txt = "There is no text entered.";
                }
                    
                foo = new SpeechSynthesisUtterance(txt);
                foo.lang = "en-US";
                foo.voice = voices[10];
                foo.pitch = pitch;
                foo.rate = rate;
                
                foo.voiceURI = 'native';
                foo.volume = 0.5;
                $('#text_annotated').val("");
                foo.onboundary = function(event){
                    var d = (new Date()).getTime();
                    if ( event.charIndex == 0) startingTimestamp = d;
                    var wordssofar= txt.substring(0, event.charIndex);
                    var newWord = txt.substring(event.charIndex);
                    newWord = newWord.substring(0,newWord.indexOf(' '));

                    var output = "index : " + event.charIndex  + "\tchar:" + txt[event.charIndex] + "\ttime:" + (d - startingTimestamp)+  "\n";
                    $('#text_annotated').val($('#text_annotated').val() + output); 
                    //$('#text_annotated').val(wordssofar +":"+ newWord); 
                    console.log(output);
                }
                window.speechSynthesis.speak(foo);


            });
        } 

        



    </script>
</html>
